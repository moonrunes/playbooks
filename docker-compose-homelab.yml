x-env: &env
  environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
  restart: unless-stopped

services:
  db:
    image: postgres
    container_name: postgres
    volumes:
      - /srv/postgres:/var/lib/postgresql/data
    <<: *env
    environment:
      - POSTGRES_DB_FILE=/run/secrets/postgres_db
      - POSTGRES_USER_FILE=/run/secrets/postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    secrets:
      - postgres_db
      - postgres_password
      - postgres_user
    deploy:
      resources:
        limits:
          memory: 100M

  app:
    image: nextcloud
    container_name: nextcloud
    ports:
      - 8080:80
    volumes:
      - /srv/nextcloud:/var/www/html
      - /mnt/storage:/mnt/storage
    <<: *env
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB_FILE=/run/secrets/postgres_db
      - POSTGRES_USER_FILE=/run/secrets/postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      - NEXTCLOUD_ADMIN_PASSWORD_FILE=/run/secrets/nextcloud_admin_password
      - NEXTCLOUD_ADMIN_USER_FILE=/run/secrets/nextcloud_admin_user
    depends_on:
      - db
    secrets:
      - nextcloud_admin_password
      - nextcloud_admin_user
      - postgres_db
      - postgres_password
      - postgres_user
    deploy:
      resources:
        limits:
          memory: 500M

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    group_add:
      - "989"
      - "985"
    ports: 
      - 8096:8096
    volumes:
      - /srv/jellyfin/config:/config
      - /srv/jellyfin/cache:/cache
      - /mnt/storage:/media
    devices:
      - /dev/dri/renderD128:/dev/dri/renderD128
    <<: *env
    environment:
      - ROC_ENABLE_PRE_VEGA=1
    deploy:
      resources:
        limits:
          memory: 1G

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    ports: 
      - 8123:8123
    volumes:
      - /srv/homeassistant/config:/config
      - /etc/localtime:/etc/localtime:ro
    <<: *env
    privileged: true
    deploy:
      resources:
        limits:
          memory: 1G

  papermc:
    image: marctv/minecraft-papermc-server:latest
    container_name: papermc
    ports:
      - 25565:25565
    volumes:
      - /srv/papermc/data:/data
    <<: *env
    deploy:
      resources:
        limits:
          memory: 9.5G

  syncthing:
    image: lscr.io/linuxserver/syncthing:latest
    container_name: syncthing
    volumes:
      - /srv/syncthing/config:/config
      - /mnt/storage:/mnt/storage
    ports:
      - 8384:8384
      - 22000:22000/tcp
      - 22000:22000/udp
      - 21027:21027/udp
    <<: *env
    deploy:
      resources:
        limits:
          memory: 500M

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    ports:
      - 80:80
    volumes:
      - /srv/vw-data:/data
    <<: *env
    deploy:
      resources:
        limits:
          memory: 500M

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    <<: *env
    deploy:
      resources:
        limits:
          memory: 50M
volumes:
  nextcloud:
  db:

secrets:
  nextcloud_admin_user:
    file: ./nextcloud_admin_user.txt
  nextcloud_admin_password:
    file: ./nextcloud_admin_password.txt
  postgres_password:
    file: ./postgres_password.txt
  postgres_db:
    file: ./postgres_db.txt
  postgres_user:
    file: ./postgres_user.txt
