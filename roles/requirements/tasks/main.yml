  - name: Load OS-specific vars
    include_vars: "{{ lookup('first_found', params) }}"
    vars:
      params:
        files:
          - '{{ansible_distribution}}.yml'
          - '{{ansible_os_family}}.yml'
          - main.yml

  - include_tasks: Archlinux.yml
    when: ansible_os_family == 'Archlinux'

  - name: Create group for ssh users
    tags:
    - init
    - user
    become: true
    become_method: doas
    ansible.builtin.group:
      name: sshusers

  - name: Add user to groups
    tags:
    - init
    - user
    become: true
    become_method: doas
    ansible.builtin.user:
      name: "{{ user_name }}"
      groups: "sshusers, wheel"
      shell: /bin/bash

  - name: Add authorized keys file
    tags:
    - init
    - ssh
    ansible.builtin.copy:
      remote_src: false
      src: ./config/authorized_keys
      dest: /home/"{{ user_name }}"/.ssh/
      mode: '0600'
      force: true

  - name: Download bash_aliases
    tags:
    - init
    - bash
    ansible.builtin.copy:
      remote_src: false
      src: ./config/.bash_aliases
      dest: /home/"{{ user_name }}"/
      mode: '0660'
      force: true

  - name: Download bashrc
    tags:
    - init
    - bash
    ansible.builtin.copy:
      remote_src: false
      src: ./config/.bashrc
      dest: /home/"{{ user_name }}"/
      mode: '0660'
      force: true

  - name: Secure SSH configuration
    tags:
    - init
    - ssh
    become: true
    become_method: doas
    ansible.builtin.copy:
      backup: true
      remote_src: false
      src: ./config/sshd_config
      dest: /etc/ssh/sshd_config
      force: true

  - name: Remove short diffie diffie-hellman
    tags:
    - init
    - ssh
    become: true
    become_method: doas
    ansible.builtin.shell: awk '$5 >= 3071' /etc/ssh/moduli > /etc/ssh/moduli.tmp && mv /etc/ssh/moduli.tmp /etc/ssh/moduli
    notify: Restart sshd

  - name: Download tmux.conf
    tags:
    - init
    - tmux
    ansible.builtin.copy:
      remote_src: false
      src: ./config/.tmux.conf
      dest: /home/"{{ user_name }}"/
      mode: '0660'
      force: true

  - name: Download ssh client config
    tags:
    - init
    - ssh
    ansible.builtin.copy:
      remote_src: false
      src: ./config/config
      dest: /home/"{{ user_name }}"/.ssh
      mode: '0660'
      force: true
